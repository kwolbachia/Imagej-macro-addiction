/*
KÃ©vin Terretaz @kWolbachia
double clic on the tool to get the imageJ LUTs montage : run("Display LUTs")
select the image which you want to set the LUT by clicking on it (it should blink in orange)
then just click on the LUT you want on the montage.
Also, if you click with the tool on another rgb image, it will make a linear LUT from the rgb pixel color
*/

var all_LUTs = getList("LUTs");

macro "set LUT from montage Tool - N55C169C168CfffD00D01D02D03D04D05D06D07D08D09D0aD0bD0cD0dD0eD10D14D15D19D1aD1eD20D24D25D29D2aD2eD30D34D35D39D3aD3eD40D44D45D49D4aD4eD50D54D55D59D5aD5eD60D64D65D69D6aD6eD70D74D75D79D7aD7eD80D84D85D89D8aD8eD90D94D95D99D9aDa0Da4Da5Da9DaaDb0Db4Db5DbaDc0Dc5Dc9DcaDceDd0Dd5Dd9DdaDe0De5DeaC500D4bD4cD4dC44aCe71C125D21D22D23C19dC298C800D7bD7cD7dC999D9eDb9Cbd2C012D46D47D48C17bC767Db1Db2Db3C438C3f9Ca87C047Dc6Dc7Dc8C1eaC8d4Cc20Cfd9Cfb4C100D1bD1cD1dC17aC368C416C47fCf92C045Da6Da7Da8C1aeC3b7Cb00D9bD9cD9dCbbbDc4Cfb3C023D66D67D68C18cC977De1De2De3C557D71D72D73C3afCd97C347D41D42D43C1afC5f6Cd51DebDecDedCcccCea7C001D26D27D28C17aC278C700D6bD6cD6dC46dCe82C406C19dC1a8Ca00D8bD8cD8dC49fCde1C012D11D12D13C18bC877Dd1Dd2Dd3C457D51D52D53C2ceCc97C158De6De7De8C1dcC888Cd30CfebCfc6C200D2bD2cD2dC667Da1Da2Da3C555DbeCfa2C247D31D32D33C5c6Cd10DbbDbcDbdCee1C034D86D87D88Ca87C667D91D92D93Cea7C358Caf3Ce61CcccDdeCfd8C000D16D17D18C268C600D5bD5cD5dCf61C035D96D97D98C198C900Cbf3C022D56D57D58C877Dc1Dc2Dc3C448Cb87C157Dd6Dd7Dd8C9d3Cd30DcbDccDcdCfb5C000C278C427Cfa3C046Db6Db7Db8C4b7Cc00DabDacDadCed3C024D76D77D78C977C557D81D82D83Cda7C348C8f5Ce50Cfb7C011D36D37D38C288C444DaeCf82C326C2a8Cb10Cde3C111Dd4De9C777C457D61D62D63Cc97C6c5Cd40DdbDdcDddC300D3bD3cD3dC666CdddC111De4C888Bf0C169D16D17D18C168D06D07D08CfffD00D04D05D0aD10D14D15D19D1aD20D24D25D29D2aD2eD30D34D35D39D3aD3eD40D44D45D49D4aD4eD50D54D55D59D5aD5eD60D64D65D69D6aD6eD70D74D75D79D7aD7eD80D84D85D89D8aD8eD90D94D95D99D9aD9eDa0Da4Da5Da9DaaDaeC500C44aCe71D1bD1cD1dC125C19dD76D77D78C298C800C999Cbd2C012C17bD46D47D48C767C438C3f9Ca87D21D22D23C047C1eaC8d4Cc20Cfd9D9bD9cD9dCfb4D5bD5cD5dC100C17aD36D37D38C368C416C47fCf92D3bD3cD3dC045C1aeD96D97D98C3b7Cb00CbbbCfb3C023C18cD66D67D68C977C557C3afCd97D61D62D63C347C1afDa6Da7Da8C5f6Cd51CcccD1eCea7D91D92D93C001C17aD26D27D28C278C700C46dCe82D2bD2cD2dC406C19dD86D87D88C1a8Ca00C49fCde1C012C18bD56D57D58C877C457C2ceCc97D51D52D53C158C1dcC888D09Cd30CfebDabDacDadCfc6D7bD7cD7dC200C667C555Cfa2D4bD4cD4dC247C5c6Cd10Cee1C034Ca87D11D12D13C667Cea7D81D82D83C358Caf3Ce61D0bD0cD0dCcccCfd8D8bD8cD8dC000C268C600Cf61C035C198C900Cbf3C022C877C448Cb87D31D32D33C157C9d3Cd30Cfb5D6bD6cD6dC000C278C427Cfa3C046C4b7Cc00Ced3C024C977D01D02D03C557Cda7D71D72D73C348C8f5Ce50Cfb7Da1Da2Da3C011C288C444Cf82C326C2a8Cb10Cde3C111C777C457Cc97D41D42D43C6c5Cd40C300C666CdddD0eC111C888B0fC169C168CfffD00D05D10D15D19D20D24D25D29D30D34D35D39D40D44D45D49D50D54D55D59D60D64D65D69D70D74D75D79D80D84D85D89D90D94D95D99Da0Da4Da5Da9C500C44aCe71C125C19dC298C800C999Cbd2D86D87D88C012C17bC767C438C3f9Ca87C047C1eaC8d4D66D67D68Cc20D81D82D83Cfd9Cfb4C100C17aC368C416C47fCf92C045C1aeC3b7D26D27D28Cb00CbbbCfb3D21D22D23C023C18cC977C557C3afCd97C347C1afC5f6Cd51CcccCea7C001C17aC278C700C46dCe82C406C19dC1a8D06D07D08Ca00C49fCde1D96D97D98C012C18bC877C457C2ceCc97C158C1dcC888Cd30D71D72D73CfebCfc6C200C667C555Cfa2C247C5c6D46D47D48Cd10Cee1Da6Da7Da8C034Ca87C667Cea7C358Caf3Ce61CcccCfd8C000C268C600Cf61D51D52D53C035C198C900Da1Da2Da3Cbf3C022C877C448Cb87C157C9d3D76D77D78Cd30Cfb5C000D09C278C427Cfa3D31D32D33C046C4b7D36D37D38Cc00Ced3D11D12D13C024C977C557Cda7C348C8f5Ce50D61D62D63Cfb7C011C288C444Cf82D41D42D43C326C2a8D16D17D18Cb10D91D92D93Cde3D01D02D03C111C777C457Cc97C6c5D56D57D58Cd40C300C666CdddC111C888D14Nf0C169C168CfffD00D01D02D03D04D05D06D07D08D09D10D14D15D19D20D24D25D29D30D34D35D39D40D44D45D49D50D54D55D59D60D64D65D69D70D74D75D79D80D84D85D89D90D94D95D99Da0Da5Da9Db0Db5Dc0Dc5Dd0Dd5De0De4De5C500C44aD21D22D23Ce71C125C19dC298Dd6Dd7Dd8C800C999Da4Dd9Cbd2C012C17bC767C438D46D47D48C3f9Da1Da2Da3Ca87C047C1eaD91D92D93C8d4Cc20Cfd9Cfb4C100C17aC368D86D87D88C416D26D27D28C47fD41D42D43Cf92C045C1aeC3b7Cb00CbbbDc9Cfb3C023C18cC977C557C3afD61D62D63Cd97C347C1afC5f6Db1Db2Db3Cd51CcccCea7C001C17aC278Db6Db7Db8C700C46dD31D32D33Ce82C406D16D17D18C19dC1a8Ca00C49fD51D52D53Cde1C012C18bC877C457C2ceD71D72D73Cc97C158C1dcD81D82D83C888Cd30CfebCfc6C200C667C555Dc4Cfa2C247C5c6Cd10Cee1C034Ca87C667Cea7C358D76D77D78Caf3Dd1Dd2Dd3Ce61CcccCfd8C000C268D96D97D98C600Cf61C035C198De6De7De8C900Cbf3De1De2De3C022C877C448D56D57D58Cb87C157C9d3Cd30Cfb5C000C278Da6Da7Da8C427D36D37D38Cfa3C046C4b7Cc00Ced3C024C977C557Cda7C348D66D67D68C8f5Dc1Dc2Dc3Ce50Cfb7C011C288Dc6Dc7Dc8C444Cf82C326D11D12D13C2a8Cb10Cde3C111C777Dd4C457Cc97C6c5Cd40C300C666Db4Db9CdddC111De9C888" 	{
	title = getTitle();
	if (bitDepth()!=24 && title!="Lookup Tables")		setTargetImage();
	else if (bitDepth()==24 && title!="Lookup Tables")	rgbPixel2LUT();
	else {
		getCursorLoc(x, y, z, modifiers);
		rows = getInfo("xMontage");
		lines = getInfo("yMontage");
		YblocSize = Image.height/lines;
		XblocSize = Image.width/rows;
		index = 0;
		linePosition = floor(y/YblocSize);
		rowPosition = floor(x/XblocSize);
		index = (linePosition*rows)+rowPosition;
		selectWindow(call("ij.Prefs.get","Destination.title",""));
		run(all_LUTs[index]);
	}
}

macro "set LUT from montage Tool Options" {
	run("Display LUTs");
}

function setTargetImage() {
	showStatus("Destination set");
	run("Alert ", "object=Image color=Orange duration=200");
	call("ij.Prefs.set","Destination.title",getTitle());
}

function rgbPixel2LUT() {
	getCursorLoc(x, y, z, modifiers);
	c = getPixel(x, y);
	r = (c>>16)&0xff; 	g = (c>>8)&0xff; b = c & 0xff; //black magic...
	selectWindow(call("ij.Prefs.get","Destination.title",""));
	LUTmaker(r,g,b);
}

function LUTmaker(r,g,b) {
	R = newArray(256); G = newArray(256); B = newArray(256);
	for(i=0; i<256; i++) { 
		R[i] = (r/256)*(i+1);
		G[i] = (g/256)*(i+1);
		B[i] = (b/256)*(i+1);
	}
	setLut(R, G, B);
}